---
title: "df_creation_bs"
author: "Bogdan Sotnikov"
date: '2023-11-15'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
lapply(c("glue", "tidyverse", "openxlsx", "readxl"), require, character.only=TRUE)
```

# Notes:
1. All whitespaces changed to underscores.
2. File вид_ТГСК.xlsx переименован в gvhd_type.xlsx


# Data reading 

```{r}
files_dd <- list.files(path = "./raw_data/3_Derivable_Datasets/", pattern = ".xls", all.files = FALSE, full.names = FALSE)
fdd <- do.call("<-", list(files_dd, sapply(files_dd, 
                                   function(x) read.xlsx(paste0("./raw_data/3_Derivable_Datasets/", x ), na.strings = NA))))

names(fdd) <- str_split_i(names(fdd), "\\.", 1)

## У файлов из второй папки общая "болезнь" -- пояснительная строка под названием столбцов
## Я не нашел тривиального решения в коде, поэтому просто убрал эту строку в экселях

files_fet <- list.files(path = "./raw_data/Final_export_tables/", pattern = ".xls", all.files = FALSE, full.names = FALSE)
fnet <- do.call("<-", list(files_fet, sapply(files_fet, 
                                   function(x) read.xlsx(paste0("./raw_data/Final_export_tables/", x), na.strings = NA, startRow = 1))))

names(fnet) <- str_split_i(names(fnet), "\\.", 1)
```

# Dataframe building

Начнем ~~плясать от печки~~ собирать датасет от файла с демографическими данными.
Затем добавим все сырые файлы, в которых единицей наблюдения является пациент (это датафреймы с данными о показаниях к пересадке, профилактикой, лечением и выживаемостью)
```{r}
# Если вы не убирали вторую строку в экселях, раскомментируйте концы строчек кода ниже (и уберите лишнюю запятую)
common_df <- left_join(left_join(left_join(left_join(fnet$DM_20230119_120304, # %>% slice(-1),
                       fnet$TU_20230119_120304 %>% select(!SITE), # %>% slice(-1),
                       by = "SUBJID"),
                       fnet$PREV_20230119_120304 %>% select(!SITE), # %>% slice(-1),
                       by = "SUBJID"),
                       fnet$TR_20230119_120304 %>% select(!SITE), # %>% slice(-1),
                       by = "SUBJID"),
                       fnet$STAT_20230119_120304 %>% 
                       select(!SITE) %>% 
                       rename(ALIVE = PTSTAT)  , # %>% slice(-1),
                       by = "SUBJID")
```

```{r}
## Добавим датасет по факту наличия той или иной формы РТПХ
## Предварительно упростим их и переведем в широкий формат

agvhd <- fnet$AGVHD_20230119_120304 %>% 
  pivot_wider(names_from = AGVHDLOC,
              values_from = AGVHDST,
              names_prefix = "acute_") %>%    # Удобно отличать повреждаемый орган + в обоих датасетах есть переменная Liver
  group_by(SUBJID) %>% 
  mutate(across(everything(), function(x) max(x, na.rm=TRUE))) %>% 
  ungroup() %>% 
  distinct(SUBJID, .keep_all = TRUE) %>% 
  select(!acute_NA)

cgvhd <- fnet$CGVHD_20230119_120304 %>% 
  pivot_wider(names_from = CGVHDLOC,
              values_from = DAMDEG,
              names_prefix = "chronic_") %>%    # Удобно отличать повреждаемый орган + в обоих датасетах есть переменная Liver
  group_by(SUBJID) %>% 
  mutate(across(everything(), function(x) max(x, na.rm=TRUE))) %>% 
  ungroup() %>% 
  distinct(SUBJID, .keep_all = TRUE) %>% 
  select(-c(chronic_NA, TYPEOTH))

fgvhd <- fnet$GVHD_20230119_120304 %>% 
  pivot_wider(names_from = GVHDCAT, values_from = GVHDYN) %>% 
  select(!GVHDOTHM) %>%    # Там одни NA
  filter(!is.na(GVHDDTC))
```



Преобразуем типы переменных

```{r}
common_df_patient <- common_df %>% 
  mutate(
    SITE = SITE %>% as.factor(),
    BIRTHDTC = format(as.Date(BIRTHDTC, format = "%d/%m/%Y"), "%d.%m.%Y") ,
    SEX = SEX %>% as.factor() ,
    ICD = ICD %>% as.factor() ,
    TUTERM = TUTERM %>% as.factor() ,
    LLTC = LLTC %>% as.factor() ,
    LLTN = LLTN %>% as.factor() ,
    PTC = PTC %>% as.factor() ,
    PTN = PTN %>% as.factor() ,
    PSOCC = PSOCC %>% as.factor() ,
    PSOCN = PSOCN %>% as.factor() ,
    PRSTDTC = format(as.Date(PRSTDTC, format = "%d/%m/%Y"), "%d.%m.%Y") , 
    TIMGDOSE = TIMGDOSE %>% as.numeric() ,
    HATGDOSE = HATGDOSE %>% as.numeric() ,
    PRENDTC =  format(as.Date(PRENDTC, format = "%d/%m/%Y"), "%d.%m.%Y") ,
    TRNUM = TRNUM %>% as.numeric() ,
    TRTYPE = TRTYPE %>% as.factor() ,
    TRDTC =  format(as.Date(TRDTC, format = "%d/%m/%Y"), "%d.%m.%Y") ,
    TRSOURCE = TRSOURCE %>% as.factor() ,
    CONDTYPE = CONDTYPE %>% as.factor() ,
    ALIVE = ALIVE %>% as.factor() ,
    LCDTC = format(as.Date(LCDTC, format = "%d/%m/%Y"), "%d.%m.%Y") ,
    DEATHDTC = format(as.Date(DEATHDTC, format = "%d/%m/%Y"), "%d.%m.%Y") ,
    RELAPYN = RELAPYN %>% as.factor(),
    RELAPDTC = format(as.Date(RELAPDTC, format = "%d/%m/%Y"), "%d.%m.%Y")
  )
```

Для текущего датафрейма единица наблюдения -- 1 пациент

Добавим информацию про острую, хроническую и оверлап РТПХ

```{r}
## Объединим с уже имеющимися данными

common_df_disease <- left_join(left_join(left_join(common_df_patient, 
                       agvhd %>% select(!SITE), 
                       by="SUBJID"),
                       cgvhd %>% select(!SITE),
                       by="SUBJID"),
                       fgvhd %>% select(!SITE),
                       by="SUBJID")
```



Преобразуем типы переменных.

```{r}
common_df_disease <- common_df_disease %>% 
  mutate(
    TRIND = case_when(                     # Эта переменная нужна для последующего объединения с терапией
     `Acute GVHD` == "yes" ~ "acute GVHD",
     `Chronic GVHD` == "yes" ~ "chronic GVHD",
     `Cross syndrome` == "yes" ~ "cross syndrome"
    ) %>% as.factor(),
    AGVHDOCC = AGVHDOCC %>% as.factor(),
    AGVHDGR = AGVHDGR %>%  as.factor() ,
    acute_Skin = acute_Skin %>%  as.factor() ,
    acute_Liver = acute_Liver %>%  as.factor() ,
    `acute_Upper gastrointestinal tract` = `acute_Upper gastrointestinal tract` %>%  as.factor() ,
    `acute_Lower gastrointestinal tract` =  `acute_Lower gastrointestinal tract` %>%  as_factor() ,
    CGVHDOCC = CGVHDOCC %>%  as.factor() ,
    PTSTAT = PTSTAT %>%  as.factor() ,
    SEVTYPE = SEVTYPE %>%  as.factor() ,
    SEVGRADE = SEVGRADE %>%  as.factor() ,
    `chronic_Skin involvement, % lesion of body surface area` = `chronic_Skin involvement, % lesion of body surface area` %>%  as.factor() ,
    `chronic_Sclerotic changes of the skin` = `chronic_Sclerotic changes of the skin` %>%  as.factor() ,
    `chronic_Changes in oral cavity` = `chronic_Changes in oral cavity` %>%  as.factor(),
    chronic_Eyes =  chronic_Eyes %>% as.factor(),
    `chronic_Gastrointestinal tract` = `chronic_Gastrointestinal tract` %>% as.factor(),
   chronic_Liver = chronic_Liver %>% as.factor(),
   `chronic_Lungs functional assessment` = `chronic_Lungs functional assessment` %>% as.factor(),
    `chronic_Joints and fascia` = `chronic_Joints and fascia` %>% as.factor(),
    `chronic_Sex organs` = `chronic_Sex organs` %>% as.factor(),
    GVHDAGE = GVHDAGE %>% as.numeric(),
    GVHDDTC = format(as.Date(GVHDDTC, format = "%d/%m/%Y"), "%d.%m.%Y") ,
    GVHDMETH = GVHDMETH %>% as.factor(),
    `Acute GVHD` = `Acute GVHD` %>% as.factor(),
    `Chronic GVHD` = `Chronic GVHD` %>% as.factor(),
    `Cross syndrome` = `Cross syndrome` %>% as.factor()
  )
```

Для нашего текущего датафрейма единица наблюдения -- наличие одного из типов РТПХ у одного пациента.

Добавим информацию о полученной терапии

```{r}
common_df_treatment <- left_join(common_df_disease,
          fnet$CM_20230119_120304 %>% select(!SITE),
          by = c("SUBJID", "TRIND"))
  
```


```{r}
common_df_treatment <- common_df_treatment %>% 
  mutate(
    GVHDTRYN = GVHDTRYN %>% as.factor(),
    LOT = LOT %>% as.factor(),
    ATCC = ATCC %>% as.factor(),
    ATCN = ATCN %>% as.factor(),
    TRRESP = TRRESP %>% as.factor(),
    RESPEV = RESPEV %>% as.factor(),
    TRONG = TRONG %>% as.factor(),
    TRSTDTC = format(as.Date(TRSTDTC, format = "%d/%m/%Y"), "%d.%m.%Y"),
    TRENDTC = format(as.Date(TRENDTC, format = "%d/%m/%Y"), "%d.%m.%Y")
  )
```


```{r}
summary(common_df_treatment)
```

Теперь единица наблюдения -- это случай получения одного препарата у одного пациента. Более аггрегированная статистика может быть получена при группировке по нужной переменной (номер пациента, тип РТПХ или оба).

Добавим информацию о факте резистентности.

Не очень понятно, как оценивать, какую линию терапии не смогли оценить/какая не показала резистентности, поскольку для подобных ситуаций не указан номер линии терапии. Оставим только данные о факте резистентности.

```{r}
coomon_df_resist <- left_join(common_df_treatment,
                              fnet$RS_20230119_120304 %>%
                                filter(REFSTYN == "yes") %>% 
                                rename(LOT = REFSTLOT),
                              by = c("SUBJID", "LOT"))

# После этого сделать проверку по дате: резистентность не может наступить раньше факта лечения.
# Вообще везде сделать проверку по дате
  
```

